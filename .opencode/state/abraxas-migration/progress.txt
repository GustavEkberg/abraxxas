# Progress Log

PRD: abraxas-migration
Started: 2026-01-19

## Codebase Patterns

<!-- Consolidate reusable patterns here -->

---

## Task - setup-1

- Added @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities, date-fns dependencies
- Files changed: package.json, pnpm-lock.yaml
- **Learnings:** Type checking passes for new deps, old_repo contains reference code with expected errors

## Task - db-1

- Added six pgEnums to schema.ts: taskStatusEnum, taskExecutionStateEnum, taskTypeEnum, taskModelEnum, sessionStatusEnum, executionModeEnum
- Files changed: lib/services/db/schema.ts
- **Learnings:** Import pgEnum from drizzle-orm/pg-core, all enum declarations precede table definitions, snake_case for enum names in DB

## Task - db-2

- Added projects table with id, userId (FK), name, description, repositoryUrl, encryptedGithubToken, agentsMdContent, createdAt, updatedAt
- Foreign key to user.id with cascade delete
- Files changed: lib/services/db/schema.ts
- **Learnings:** Table follows standard pattern: cuid primary key, notNull constraints, cascade delete on FK, $onUpdate for updatedAt

## Task - db-3

- Added tasks table with id, projectId (FK), title, description, type (enum), model (enum), status (enum), executionState (enum), branchName, completedAt, createdAt, updatedAt
- Foreign key to projects.id with cascade delete
- Status defaults to 'abyss', executionState defaults to 'idle'
- Files changed: lib/services/db/schema.ts
- **Learnings:** Enum columns reference pgEnum definitions, default values set with .default(), nullable fields omit .notNull()

## Task - db-4

- Added comments table with id, taskId (FK), userId (nullable FK), isAgentComment (boolean), agentName (nullable), content, createdAt, updatedAt
- Foreign keys: tasks.id (cascade delete), user.id (cascade delete, nullable)
- isAgentComment defaults to false
- Files changed: lib/services/db/schema.ts
- **Learnings:** Nullable FKs omit .notNull(), both user and agent comments stored in same table with isAgentComment flag

## Task - db-5

- Added opencodeSessions table for tracking Sprites.dev execution lifecycle
- Columns: id, taskId (FK), sessionId, status (enum), executionMode (enum), spriteName, webhookSecret, branchName, pullRequestUrl, errorMessage, logs, messageCount, inputTokens, outputTokens, createdAt, updatedAt, completedAt
- Foreign key to tasks.id with cascade delete
- Status defaults to 'pending', all token/message/log fields are text (nullable)
- Files changed: lib/services/db/schema.ts
- **Learnings:** Session tracking table holds execution metadata, webhookSecret for HMAC verification, completedAt nullable for in-flight sessions

## Task - db-6

- Configured Drizzle relations for all new tables using RQB v2 defineRelations API
- Relations added: user->projects (many), projects->user (one), projects->tasks (many), tasks->project (one), tasks->comments (many), tasks->opencodeSessions (many), comments->task (one), comments->user (one, optional), opencodeSessions->task (one)
- Files changed: lib/services/db/schema.ts
- **Learnings:** defineRelations takes all tables in first arg, relations map in second; r.one/r.many methods with from/to fields; optional flag for nullable FKs
