{
  "prdName": "abraxas-migration",
  "tasks": [
    {
      "id": "setup-1",
      "category": "setup",
      "description": "Add required dependencies: @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities, date-fns",
      "steps": [
        "Run pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities date-fns",
        "Verify packages appear in package.json dependencies",
        "Run pnpm tsc to ensure no type errors from new deps"
      ],
      "passes": true
    },
    {
      "id": "db-1",
      "category": "db",
      "description": "Add pgEnums for task status, execution state, type, model, session status, execution mode",
      "steps": [
        "taskStatusEnum exists with values: abyss, altar, ritual, cursed, trial, vanquished",
        "taskExecutionStateEnum exists with values: idle, in_progress, awaiting_review, completed, error",
        "taskTypeEnum exists with values: bug, feature, plan, other",
        "taskModelEnum exists with values: grok-1, claude-opus-4-5, claude-sonnet-4-5, claude-haiku-4-5",
        "sessionStatusEnum exists with values: pending, in_progress, completed, error",
        "executionModeEnum exists with values: local, sprite",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-2",
      "category": "db",
      "description": "Add projects table with encrypted GitHub token field",
      "steps": [
        "projects table exists in schema.ts",
        "Columns: id (text, cuid), userId (FK to user), name, description, repositoryUrl, encryptedGithubToken, agentsMdContent, createdAt, updatedAt",
        "Foreign key references user.id with cascade delete",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-3",
      "category": "db",
      "description": "Add tasks table with all enums and foreign key to projects",
      "steps": [
        "tasks table exists in schema.ts",
        "Columns: id, projectId (FK), title, description, type (enum), model (enum), status (enum), executionState (enum), branchName, completedAt, createdAt, updatedAt",
        "Foreign key references projects.id with cascade delete",
        "Status defaults to 'abyss', executionState defaults to 'idle'",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-4",
      "category": "db",
      "description": "Add comments table supporting user and agent comments",
      "steps": [
        "comments table exists in schema.ts",
        "Columns: id, taskId (FK), userId (nullable FK), isAgentComment (boolean), agentName (nullable), content, createdAt, updatedAt",
        "Foreign key to tasks.id with cascade delete",
        "Foreign key to user.id with cascade delete (nullable)",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-5",
      "category": "db",
      "description": "Add opencodeSessions table for execution tracking",
      "steps": [
        "opencodeSessions table exists in schema.ts",
        "Columns: id, taskId (FK), sessionId, status (enum), executionMode (enum), spriteName, webhookSecret, branchName, pullRequestUrl, errorMessage, logs, messageCount, inputTokens, outputTokens, createdAt, updatedAt, completedAt",
        "Foreign key to tasks.id with cascade delete",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-6",
      "category": "db",
      "description": "Configure Drizzle relations for all new tables",
      "steps": [
        "User has many projects relation",
        "Project has many tasks relation",
        "Task has many comments relation",
        "Task has many opencodeSessions relation",
        "All relations use Drizzle v1.0 RQB v2 defineRelations API",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-7",
      "category": "db",
      "description": "Remove example post table from schema",
      "steps": [
        "post table removed from schema.ts",
        "post relation removed from defineRelations",
        "No references to post remain in codebase (except old_repo)",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "db-8",
      "category": "db",
      "description": "Run database migration to apply schema changes",
      "steps": [
        "Run pnpm db:generate to create migration",
        "Run pnpm db:migrate to apply migration",
        "Verify tables exist in database"
      ],
      "passes": true
    },
    {
      "id": "service-1",
      "category": "service",
      "description": "Create Sprites Effect service with API client methods",
      "steps": [
        "lib/services/sprites/live-layer.ts exists",
        "Sprites class extends Effect.Service with tag '@app/Sprites'",
        "Methods: createSprite, getSprite, destroySprite, execCommand, listSprites",
        "Uses Effect Config for SPRITES_TOKEN",
        "Has static layer and Live properties",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "service-2",
      "category": "service",
      "description": "Create Sprites service error types",
      "steps": [
        "lib/services/sprites/errors.ts exists",
        "SpritesApiError extends Data.TaggedError",
        "SpritesNotFoundError extends Data.TaggedError",
        "SpritesConfigError extends Data.TaggedError",
        "SpriteExecutionError extends Data.TaggedError",
        "All errors have appropriate fields (message, cause, spriteName, etc.)",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "service-3",
      "category": "service",
      "description": "Add Sprites service to AppLayer",
      "steps": [
        "Import Sprites from lib/services/sprites/live-layer",
        "Add Sprites.Live to Layer.mergeAll in lib/layers.ts",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "security-1",
      "category": "security",
      "description": "Create encryption utilities for GitHub tokens",
      "steps": [
        "lib/core/crypto/encrypt.ts exists",
        "encryptToken function using AES-256-GCM",
        "decryptToken function",
        "Uses ENCRYPTION_KEY from Effect Config",
        "Returns Effect with appropriate error types",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-project-1",
      "category": "domain",
      "description": "Create get-projects.ts for RSC data loading",
      "steps": [
        "lib/core/project/get-projects.ts exists",
        "Returns Effect with array of projects for current user",
        "Uses Db service and getSession",
        "Filters by userId from session",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-project-2",
      "category": "domain",
      "description": "Create get-project.ts for single project loading",
      "steps": [
        "lib/core/project/get-project.ts exists",
        "Returns Effect with single project by ID",
        "Verifies user owns the project",
        "Returns NotFoundError if project doesn't exist",
        "Returns UnauthorizedError if user doesn't own project",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-project-3",
      "category": "domain",
      "description": "Create create-project-action.ts server action",
      "steps": [
        "lib/core/project/create-project-action.ts exists",
        "'use server' directive at top",
        "Accepts name, description, repositoryUrl, githubToken, agentsMdContent",
        "Encrypts githubToken before storage",
        "Uses NextEffect.runPromise pattern",
        "Returns error object on failure or revalidates on success",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-project-4",
      "category": "domain",
      "description": "Create update-project-action.ts server action",
      "steps": [
        "lib/core/project/update-project-action.ts exists",
        "'use server' directive at top",
        "Accepts projectId and partial update fields",
        "Re-encrypts githubToken if provided",
        "Verifies user owns project before update",
        "Uses NextEffect.runPromise pattern",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-project-5",
      "category": "domain",
      "description": "Create delete-project-action.ts server action",
      "steps": [
        "lib/core/project/delete-project-action.ts exists",
        "'use server' directive at top",
        "Accepts projectId",
        "Verifies user owns project before delete",
        "Uses NextEffect.runPromise pattern",
        "Revalidates path on success",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-task-1",
      "category": "domain",
      "description": "Create get-tasks.ts for RSC data loading",
      "steps": [
        "lib/core/task/get-tasks.ts exists",
        "Returns Effect with array of tasks for a project",
        "Accepts projectId parameter",
        "Verifies user owns the project",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-task-2",
      "category": "domain",
      "description": "Create create-task-action.ts server action",
      "steps": [
        "lib/core/task/create-task-action.ts exists",
        "'use server' directive at top",
        "Accepts projectId, title, description, type, model",
        "Verifies user owns project",
        "Sets default status='abyss', executionState='idle'",
        "Uses NextEffect.runPromise pattern",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-task-3",
      "category": "domain",
      "description": "Create update-task-action.ts server action",
      "steps": [
        "lib/core/task/update-task-action.ts exists",
        "'use server' directive at top",
        "Accepts taskId and partial update (status, type, model, executionState, branchName)",
        "Verifies user owns parent project",
        "Uses NextEffect.runPromise pattern",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-task-4",
      "category": "domain",
      "description": "Create delete-task-action.ts server action",
      "steps": [
        "lib/core/task/delete-task-action.ts exists",
        "'use server' directive at top",
        "Accepts taskId",
        "Verifies user owns parent project",
        "Uses NextEffect.runPromise pattern",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-task-5",
      "category": "domain",
      "description": "Create execute-task-action.ts for Sprites.dev execution",
      "steps": [
        "lib/core/task/execute-task-action.ts exists",
        "'use server' directive at top",
        "Accepts taskId",
        "Verifies user owns parent project",
        "Checks task not already executing",
        "Builds prompt from task + comments",
        "Spawns sprite via Sprites service",
        "Creates opencode session record",
        "Posts 'started' agent comment",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-comment-1",
      "category": "domain",
      "description": "Create get-comments.ts for RSC data loading",
      "steps": [
        "lib/core/comment/get-comments.ts exists",
        "Returns Effect with array of comments for a task",
        "Accepts taskId parameter",
        "Ordered by createdAt ascending",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": true
    },
    {
      "id": "domain-comment-2",
      "category": "domain",
      "description": "Create create-comment-action.ts server action",
      "steps": [
        "lib/core/comment/create-comment-action.ts exists",
        "'use server' directive at top",
        "Accepts taskId and content",
        "Sets userId from session, isAgentComment=false",
        "Verifies user can access task (owns parent project)",
        "Uses NextEffect.runPromise pattern",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "domain-comment-3",
      "category": "domain",
      "description": "Create create-agent-comment.ts internal function",
      "steps": [
        "lib/core/comment/create-agent-comment.ts exists",
        "NOT a server action (no 'use server')",
        "Returns Effect that creates comment with isAgentComment=true",
        "Accepts taskId, content, agentName",
        "Has Effect.withSpan annotation",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "domain-session-1",
      "category": "domain",
      "description": "Create session management functions",
      "steps": [
        "lib/core/session/create-session.ts exists",
        "lib/core/session/update-session.ts exists",
        "lib/core/session/get-latest-session.ts exists",
        "All return Effect with appropriate types",
        "update-session handles status changes and stats updates",
        "get-latest-session returns most recent session for a taskId",
        "All have Effect.withSpan annotations",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "api-1",
      "category": "api",
      "description": "Create Sprite webhook handler API route",
      "steps": [
        "app/api/webhooks/sprite/[taskId]/route.ts exists",
        "POST handler extracts taskId from params",
        "Reads raw body for signature verification",
        "Gets X-Webhook-Signature header",
        "Verifies HMAC signature using session's webhookSecret",
        "Uses timing-safe comparison",
        "Returns 401 if signature invalid",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "api-2",
      "category": "api",
      "description": "Implement webhook payload type handlers",
      "steps": [
        "Webhook handles 'started' type: posts agent comment",
        "Webhook handles 'progress' type: updates session stats",
        "Webhook handles 'completed' type: moves task to 'trial', posts summary",
        "Webhook handles 'error' type: moves task to 'cursed', posts error",
        "Webhook handles 'question' type: posts question as agent comment",
        "Destroys sprite after completed/error (not progress/question)",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "context-1",
      "category": "context",
      "description": "Create FireIntensityContext provider",
      "steps": [
        "lib/contexts/fire-intensity-context.tsx exists",
        "FireIntensityProvider component with children prop",
        "Exports useFireIntensity hook",
        "Tracks running tasks with id, startedAt, messageCount",
        "addRunningTask, removeRunningTask, updateTaskMessages functions",
        "calculateIntensity: base 10 per task + message bonus (max 10) + time bonus (1 per 30s, max 15)",
        "Recalculates intensity every second",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-1",
      "category": "component",
      "description": "Create AsciiFire component",
      "steps": [
        "components/ascii-fire.tsx exists",
        "Accepts intensity prop (number)",
        "Renders pre element with fire animation",
        "Uses requestAnimationFrame for animation loop",
        "Fire height caps at intensity 35",
        "Above 35, color shifts from white to red/yellow",
        "Smoothly interpolates intensity changes",
        "Fixed at bottom of screen, pointer-events-none",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-2",
      "category": "component",
      "description": "Create FireBackground wrapper component",
      "steps": [
        "components/fire-background.tsx exists",
        "'use client' directive",
        "Uses useFireIntensity to get intensity value",
        "Renders AsciiFire with intensity prop",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-3",
      "category": "component",
      "description": "Create CreateRitualDialog component",
      "steps": [
        "components/rituals/create-ritual-dialog.tsx exists",
        "'use client' directive",
        "Form with fields: name, description, repositoryUrl, githubToken, agentsMdContent",
        "Calls create-project-action on submit",
        "Shows loading state during submission",
        "Shows error message on failure",
        "Redirects to ritual board on success",
        "Uses shadcn Dialog, Input, Textarea, Button, Label",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-4",
      "category": "component",
      "description": "Create CreateInvocationDialog component",
      "steps": [
        "components/invocations/create-invocation-dialog.tsx exists",
        "'use client' directive",
        "Form with fields: title, description, type (select), model (select)",
        "Accepts ritualId prop",
        "Calls create-task-action on submit",
        "Type options: bug, feature, plan, other",
        "Model options: grok-1, claude-sonnet-4-5, claude-opus-4-5, claude-haiku-4-5",
        "Shows loading and error states",
        "Uses shadcn Dialog, Input, Textarea, Select, Button, Label",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-5",
      "category": "component",
      "description": "Create Comment component for display",
      "steps": [
        "components/invocations/comment.tsx exists",
        "Accepts: content, isAgentComment, agentName, userName, createdAt",
        "User comments: left-aligned, purple styling",
        "Agent comments: right-aligned, cyan styling",
        "Shows relative timestamp (uses date-fns)",
        "Whitespace preserved for markdown",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-6",
      "category": "component",
      "description": "Create AddCommentForm component",
      "steps": [
        "components/invocations/add-comment-form.tsx exists",
        "'use client' directive",
        "Accepts onSubmit callback prop",
        "Textarea for content input",
        "Submit button with loading state",
        "Clears form on successful submit",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "component-7",
      "category": "component",
      "description": "Create TaskDetailModal component",
      "steps": [
        "components/invocations/task-detail-modal.tsx exists",
        "'use client' directive",
        "Accepts: task, ritualId, repositoryUrl, open, onOpenChange, onUpdate",
        "Shows task title, description, status, type, model, executionState",
        "Shows branch link if branchName exists",
        "Shows session stats if available",
        "Lists comments with Comment component",
        "Includes AddCommentForm",
        "Select dropdowns for type, model, executionState changes",
        "Delete button with confirmation dialog",
        "Uses shadcn Dialog, Select, Button",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "page-1",
      "category": "page",
      "description": "Create Ritual Chamber page (dashboard)",
      "steps": [
        "app/(dashboard)/page.tsx exists",
        "export const dynamic = 'force-dynamic'",
        "Uses Suspense + Content pattern",
        "Content component fetches projects via get-projects.ts",
        "Shows grid of project cards",
        "Each card shows name, description, repositoryUrl, createdAt",
        "Click card navigates to /rituals/[id]",
        "CreateRitualDialog button in header",
        "Logout button in header",
        "Empty state when no projects",
        "Loading state in Suspense fallback",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "page-2",
      "category": "page",
      "description": "Create Ritual Board page (kanban)",
      "steps": [
        "app/(dashboard)/rituals/[id]/page.tsx exists",
        "export const dynamic = 'force-dynamic'",
        "Uses Suspense + Content pattern",
        "Content fetches project and tasks",
        "DndContext with PointerSensor",
        "Six columns: abyss, altar, ritual, cursed, trial, vanquished",
        "DroppableColumn component for each column",
        "DraggableCard component for each task",
        "Drag from altar to ritual triggers execute-task-action",
        "Optimistic UI updates on drag",
        "Back button to return to chamber",
        "CreateInvocationDialog button",
        "TaskDetailModal on card click",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "page-3",
      "category": "page",
      "description": "Integrate FireIntensityProvider and FireBackground into layout",
      "steps": [
        "app/layout.tsx wraps children with FireIntensityProvider",
        "FireBackground rendered inside provider",
        "Fire appears at bottom of all pages",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "style-1",
      "category": "style",
      "description": "Update globals.css with occult theme",
      "steps": [
        "IBM Plex Mono configured as --font-sans and --font-mono",
        "--background: 0 0% 4% (almost black)",
        "--primary: 270 60% 60% (purple accent)",
        "--destructive: 0 62% 50% (red)",
        "body has font-mono class",
        "ASCII border utilities present",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "style-2",
      "category": "style",
      "description": "Configure IBM Plex Mono font in layout",
      "steps": [
        "next/font/google import for IBM_Plex_Mono",
        "Font applied to html element",
        "CSS variable --font-ibm-plex-mono set",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "polish-1",
      "category": "polish",
      "description": "Add status polling for running tasks on board page",
      "steps": [
        "Board page polls for status updates every 10 seconds",
        "Only polls when tasks are in_progress",
        "Updates task list on status change",
        "Updates fire intensity context with message counts",
        "Persists running task IDs to localStorage across refresh",
        "pnpm tsc passes"
      ],
      "passes": false
    },
    {
      "id": "verify-1",
      "category": "verify",
      "description": "Verify full type safety and lint compliance",
      "steps": [
        "pnpm tsc passes with no errors",
        "pnpm lint passes with no errors",
        "No any types in new code",
        "No as type assertions in new code",
        "No disableValidation usage"
      ],
      "passes": false
    },
    {
      "id": "verify-2",
      "category": "verify",
      "description": "Verify existing tests still pass",
      "steps": ["pnpm test:run passes", "No regressions in existing functionality"],
      "passes": false
    },
    {
      "id": "docs-1",
      "category": "docs",
      "description": "Update AGENTS.md with new domain structure",
      "steps": [
        "Add project/, task/, comment/, session/ to WHERE TO LOOK table",
        "Add Sprites service to service hierarchy",
        "Document new environment variables: SPRITES_TOKEN, WEBHOOK_BASE_URL, ENCRYPTION_KEY",
        "Update CODE MAP with new key symbols"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "Db service: lib/services/db/live-layer.ts",
      "Auth service: lib/services/auth/live-layer.ts",
      "Server action pattern: specs/DATA_ACCESS_PATTERNS.md",
      "Page pattern: specs/PAGE_PATTERNS.md",
      "Effect best practices: specs/EFFECT_BEST_PRACTICES.md"
    ],
    "keyFiles": [
      "lib/layers.ts",
      "lib/services/db/schema.ts",
      "lib/services/db/live-layer.ts",
      "lib/next-effect/index.ts",
      "app/layout.tsx",
      "old_repo/schemas/index.ts",
      "old_repo/app/(dashboard)/rituals/[id]/page.tsx",
      "old_repo/lib/sprites/client.ts",
      "old_repo/lib/sprites/lifecycle.ts",
      "old_repo/components/ascii-fire.tsx",
      "old_repo/lib/contexts/fire-intensity-context.tsx"
    ],
    "nonGoals": [
      "Ralph Loop mode (autonomous task execution)",
      "GitHub PR creation (agent handles this)",
      "Multi-user/team support",
      "Real-time WebSocket updates",
      "Mobile responsiveness",
      "Light mode theme"
    ]
  }
}
