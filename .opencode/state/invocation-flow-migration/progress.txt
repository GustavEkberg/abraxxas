# Progress Log

PRD: invocation-flow-migration
Started: 2026-01-22

## Codebase Patterns

- **Drizzle migrations**: Run `pnpm db:generate --name <migration-name>` to create migration, then `pnpm drizzle-kit migrate` to apply
- **Schema location**: `lib/services/db/schema.ts` - all tables defined here
- **Optional text columns**: Use `text('columnName')` (nullable by default)

---

## Task - db-1

- Added `spriteUrl` and `spritePassword` text columns to `opencodeSessions` table in schema.ts (after `spriteName`)
- Files changed:
  - `lib/services/db/schema.ts` - added two columns
  - `lib/services/db/migrations/20260122110059_add-session-sprite-credentials/` - generated migration
- **Learnings:** Pattern mirrors `manifests` table which already has these columns (line 211-212)

## Task - backend-1

- Updated `spawnSpriteForTask` to return `spriteUrl` and `spritePassword`
- Updated `executeTaskAction` to store credentials in `opencodeSessions` record
- Files changed:
  - `lib/core/sprites/spawn-sprite.ts` - added `generateSpritePassword()`, capture `sprite.url`, updated interface and return
  - `lib/core/task/execute-task-action.ts` - destructure new fields, store in session insert
- **Learnings:** 
  - Sprites API returns `url` from `createSprite` response (see `lib/services/sprites/live-layer.ts:12-23`)
  - Changed sprite auth from 'sprite' to 'public' to allow external access (matches manifest pattern)

## Task - backend-2

- Removed automatic sprite destruction from webhook handlers on completion and error
- Files changed:
  - `app/api/webhooks/sprite/[taskId]/route.ts` - removed `destroySprite` calls from `handleCompleted` and `handleError`, removed unused `Sprites` import
- **Learnings:**
  - Task status transitions still work (trial/cursed) - these are independent of sprite lifecycle
  - Sprite now persists after task completion/error, allowing user to manually inspect/debug via UI

## Task - backend-3

- Simplified `buildPrompt` to only include task title and description
- Removed comments fetching from `executeTaskAction`
- Files changed:
  - `lib/core/task/execute-task-action.ts` - simplified `buildPrompt` signature, removed comments query
- **Learnings:**
  - Comments are still created by agent (line 143) but no longer fed into the initial prompt
  - This is part of simplifying the invocation flow - comments UI will be removed in ui-4

## Task - backend-4

- Created `destroySpriteAction(sessionId)` server action
- Files changed:
  - `lib/core/task/destroy-sprite-action.ts` - new file
- **Implementation details:**
  - Looks up session by ID, then task, then project to verify ownership
  - Uses `sprites.destroySprite(spriteName)` with catchAll (sprite may already be destroyed)
  - Clears `spriteName`, `spriteUrl`, `spritePassword` from session record
  - Returns `{ _tag: 'Success' }` or `{ _tag: 'Error', message: string }` 
  - Follows exact pattern from `delete-manifest-action.ts` (line 49-60)
- **Learnings:** 
  - Ownership verification chain: session -> task -> project -> user.id check
  - Pattern to catch sprite destruction errors (sprite may already be gone) is standard

## Task - ui-1

- Added sprite action buttons to task cards (copy sprite name, copy URL, copy password, open external)
- Extended TaskStats interface to include `spriteName`, `spriteUrl`, `spritePassword`
- Added CopyButton component to board-client.tsx (reused pattern from manifest-card.tsx)
- Files changed:
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - added CopyButton, sprite buttons in DraggableCard, extended TaskStats
  - `app/(dashboard)/rituals/[id]/page.tsx` - extended stats map to include sprite credentials from session
- **Learnings:**
  - Task card data flows from page.tsx via props, not fetched per-card
  - Sessions already contain sprite credentials; just need to pass them through TaskStats
  - Button pattern: stopPropagation() on click handlers prevents card click interference

## Task - ui-2

- Added destroy sprite button (Trash2 icon) to task cards when spriteName exists
- Button shows gnostic confirmation dialog with title "Banish this Invocation?"
- On confirmation, calls destroySpriteAction and refreshes the UI
- Files changed:
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - added Trash2 import, useAlert hook, handleDestroySprite callback, destroy button in DraggableCard
  - `app/(dashboard)/rituals/[id]/page.tsx` - added sessionId to stats map (required for destroySpriteAction)
- **Learnings:**
  - useAlert hook provides imperative `confirm()` method that returns Promise<boolean>
  - Pattern: pass onDestroySprite prop only when sprite exists (conditional prop)
  - sessionId needed in TaskStats interface to call destroySpriteAction

## Task - ui-3

- Updated task statistics styling to match manifest card muted aesthetic
- Stats already displayed (messageCount + tokens) from prior work; adjusted colors
- Files changed:
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - changed stats span from `bg-red-500/10 text-red-400` to `bg-white/5 text-white/40`
- **Learnings:**
  - Manifest card uses `text-white/40` for muted secondary info (see ManifestProgress at line 128)
  - Task cards already had monospace via `font-mono` on parent containers

## Task - ui-4

- Removed all comments UI from task detail modal
- Deleted unused comment-related components
- Simplified `getTaskDetailsAction` to only return session data (not comments)
- Files changed:
  - `components/invocations/task-detail-modal.tsx` - removed Comment/AddCommentForm imports, removed comments prop/state/handlers, removed comments section UI
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - removed `comments` prop from TaskDetailModal
  - `lib/core/task/get-task-details-action.ts` - removed comments from interface and fetch logic
  - `components/invocations/add-comment-form.tsx` - deleted
  - `components/invocations/comment.tsx` - deleted
- **Learnings:**
  - Comments were only used in task-detail-modal - no other consumers
  - Server action cleanup required coordinating with client components that use the result type

## Task - ui-5

- Simplified task detail modal to show only essential information
- Removed type/model/state Select dropdowns (and their handlers)
- Removed session stats section (messageCount, tokens)
- Added execution error display when task is in error state
- Changed "Description" section header to "Initial Prompt" with title + description
- Files changed:
  - `components/invocations/task-detail-modal.tsx` - major simplification (398 -> 158 lines)
  - `lib/core/task/get-task-details-action.ts` - now only returns `errorMessage` instead of full session stats
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - updated TaskDetailModal props (session -> errorMessage)
- **Learnings:**
  - Modal now focused: title, error (if any), branch link (if any), initial prompt, delete button
  - Task type/model/state editing was not needed for the invocation flow
  - Session stats (messages, tokens) are displayed on the card itself via TaskStats
