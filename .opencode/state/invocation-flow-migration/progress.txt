# Progress Log

PRD: invocation-flow-migration
Started: 2026-01-22

## Codebase Patterns

- **Drizzle migrations**: Run `pnpm db:generate --name <migration-name>` to create migration, then `pnpm drizzle-kit migrate` to apply
- **Schema location**: `lib/services/db/schema.ts` - all tables defined here
- **Optional text columns**: Use `text('columnName')` (nullable by default)

---

## Task - db-1

- Added `spriteUrl` and `spritePassword` text columns to `opencodeSessions` table in schema.ts (after `spriteName`)
- Files changed:
  - `lib/services/db/schema.ts` - added two columns
  - `lib/services/db/migrations/20260122110059_add-session-sprite-credentials/` - generated migration
- **Learnings:** Pattern mirrors `manifests` table which already has these columns (line 211-212)

## Task - backend-1

- Updated `spawnSpriteForTask` to return `spriteUrl` and `spritePassword`
- Updated `executeTaskAction` to store credentials in `opencodeSessions` record
- Files changed:
  - `lib/core/sprites/spawn-sprite.ts` - added `generateSpritePassword()`, capture `sprite.url`, updated interface and return
  - `lib/core/task/execute-task-action.ts` - destructure new fields, store in session insert
- **Learnings:** 
  - Sprites API returns `url` from `createSprite` response (see `lib/services/sprites/live-layer.ts:12-23`)
  - Changed sprite auth from 'sprite' to 'public' to allow external access (matches manifest pattern)

## Task - backend-2

- Removed automatic sprite destruction from webhook handlers on completion and error
- Files changed:
  - `app/api/webhooks/sprite/[taskId]/route.ts` - removed `destroySprite` calls from `handleCompleted` and `handleError`, removed unused `Sprites` import
- **Learnings:**
  - Task status transitions still work (trial/cursed) - these are independent of sprite lifecycle
  - Sprite now persists after task completion/error, allowing user to manually inspect/debug via UI

## Task - backend-3

- Simplified `buildPrompt` to only include task title and description
- Removed comments fetching from `executeTaskAction`
- Files changed:
  - `lib/core/task/execute-task-action.ts` - simplified `buildPrompt` signature, removed comments query
- **Learnings:**
  - Comments are still created by agent (line 143) but no longer fed into the initial prompt
  - This is part of simplifying the invocation flow - comments UI will be removed in ui-4
