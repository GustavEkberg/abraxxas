# Progress Log

PRD: invocation-flow-migration
Started: 2026-01-22

## Codebase Patterns

- **Drizzle migrations**: Run `pnpm db:generate --name <migration-name>` to create migration, then `pnpm drizzle-kit migrate` to apply
- **Schema location**: `lib/services/db/schema.ts` - all tables defined here
- **Optional text columns**: Use `text('columnName')` (nullable by default)

---

## Task - db-1

- Added `spriteUrl` and `spritePassword` text columns to `opencodeSessions` table in schema.ts (after `spriteName`)
- Files changed:
  - `lib/services/db/schema.ts` - added two columns
  - `lib/services/db/migrations/20260122110059_add-session-sprite-credentials/` - generated migration
- **Learnings:** Pattern mirrors `manifests` table which already has these columns (line 211-212)

## Task - backend-1

- Updated `spawnSpriteForTask` to return `spriteUrl` and `spritePassword`
- Updated `executeTaskAction` to store credentials in `opencodeSessions` record
- Files changed:
  - `lib/core/sprites/spawn-sprite.ts` - added `generateSpritePassword()`, capture `sprite.url`, updated interface and return
  - `lib/core/task/execute-task-action.ts` - destructure new fields, store in session insert
- **Learnings:** 
  - Sprites API returns `url` from `createSprite` response (see `lib/services/sprites/live-layer.ts:12-23`)
  - Changed sprite auth from 'sprite' to 'public' to allow external access (matches manifest pattern)

## Task - backend-2

- Removed automatic sprite destruction from webhook handlers on completion and error
- Files changed:
  - `app/api/webhooks/sprite/[taskId]/route.ts` - removed `destroySprite` calls from `handleCompleted` and `handleError`, removed unused `Sprites` import
- **Learnings:**
  - Task status transitions still work (trial/cursed) - these are independent of sprite lifecycle
  - Sprite now persists after task completion/error, allowing user to manually inspect/debug via UI

## Task - backend-3

- Simplified `buildPrompt` to only include task title and description
- Removed comments fetching from `executeTaskAction`
- Files changed:
  - `lib/core/task/execute-task-action.ts` - simplified `buildPrompt` signature, removed comments query
- **Learnings:**
  - Comments are still created by agent (line 143) but no longer fed into the initial prompt
  - This is part of simplifying the invocation flow - comments UI will be removed in ui-4

## Task - backend-4

- Created `destroySpriteAction(sessionId)` server action
- Files changed:
  - `lib/core/task/destroy-sprite-action.ts` - new file
- **Implementation details:**
  - Looks up session by ID, then task, then project to verify ownership
  - Uses `sprites.destroySprite(spriteName)` with catchAll (sprite may already be destroyed)
  - Clears `spriteName`, `spriteUrl`, `spritePassword` from session record
  - Returns `{ _tag: 'Success' }` or `{ _tag: 'Error', message: string }` 
  - Follows exact pattern from `delete-manifest-action.ts` (line 49-60)
- **Learnings:** 
  - Ownership verification chain: session -> task -> project -> user.id check
  - Pattern to catch sprite destruction errors (sprite may already be gone) is standard

## Task - ui-1

- Added sprite action buttons to task cards (copy sprite name, copy URL, copy password, open external)
- Extended TaskStats interface to include `spriteName`, `spriteUrl`, `spritePassword`
- Added CopyButton component to board-client.tsx (reused pattern from manifest-card.tsx)
- Files changed:
  - `app/(dashboard)/rituals/[id]/board-client.tsx` - added CopyButton, sprite buttons in DraggableCard, extended TaskStats
  - `app/(dashboard)/rituals/[id]/page.tsx` - extended stats map to include sprite credentials from session
- **Learnings:**
  - Task card data flows from page.tsx via props, not fetched per-card
  - Sessions already contain sprite credentials; just need to pass them through TaskStats
  - Button pattern: stopPropagation() on click handlers prevents card click interference
