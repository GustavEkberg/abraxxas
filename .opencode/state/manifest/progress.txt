# Progress Log

PRD: manifest
Started: 2026-01-20

## Codebase Patterns

- **DB enums**: Use `pgEnum` from drizzle-orm/pg-core, snake_case name, place in ENUMS section of schema.ts
- **DB tables**: Use `pgTable` with cuid2 id generation via `$defaultFn(() => createId())`
- **Relations**: Use `defineRelations` with RQB v2 API (r.many/r.one patterns)

---

## Task - db-1

- Added `manifestStatusEnum` with values: pending, active, running, completed, error
- Files changed: lib/services/db/schema.ts
- **Learnings:** Enums go in the ENUMS section around line 6-42

## Task - db-2

- Added `manifests` table with all required columns
- Files changed: lib/services/db/schema.ts (lines 193-220)
- Columns: id, projectId (FK), prdName, status (enum), spriteName, spriteUrl, spritePassword, webhookSecret, prdJson, errorMessage, createdAt, updatedAt, completedAt
- **Learnings:** Tables go in their own section; nullable columns need no `.notNull()`

## Task - db-3

- Added manifests to relations registry in `defineRelations`
- Added `projects.manifests: r.many.manifests` relation
- Added `manifests.project: r.one.projects` relation  
- Files changed: lib/services/db/schema.ts (lines 274-352)
- **Learnings:** Arrow function returning object needs `})` not just `}` before closing `defineRelations)`

## Task - db-4

- Generated migration via `pnpm db:generate`
- Applied migration via `pnpm drizzle-kit push` (no `db:migrate` script exists)
- `manifests` table created in database with all columns and FK constraint
- **Learnings:** Project uses `db:push` not `db:migrate`; `drizzle-kit migrate` requires journal tracking but project uses push workflow

## Task - service-1

- Added `updateUrlSettings(name, auth)` method to Sprites service
- Makes PUT request to `/v1/sprites/{name}` with `{ url_settings: { auth } }` body
- Returns updated `Sprite` object
- Follows existing method pattern with `Effect.withSpan`, `Effect.annotateCurrentSpan`, `Effect.tapError`
- Files changed: lib/services/sprites/live-layer.ts
- **Learnings:** Sprites service methods follow consistent pattern: annotate span, make request, validate response, add withSpan + tapError

## Task - domain-1

- Created `lib/core/manifest/spawn-manifest-sprite.ts`
- Generates sprite name: `manifest-{projectId-short}-{timestamp}`
- Generates 32-char alphanumeric password via `randomBytes`
- Creates sprite with `url_settings.auth = 'public'`
- Clones repo with decrypted GitHub token
- Uploads opencode auth.json if user has one
- Downloads abraxas-opencode-setup and installs commands/skills/task-loop
- Sends 'started' webhook via HMAC-signed POST
- Returns `{ spriteName, spriteUrl, spritePassword, webhookSecret }`
- Files changed: lib/core/manifest/spawn-manifest-sprite.ts (new)
- **Learnings:** Manifest sprites need manifestId for webhook URL; sprite setup includes opencode install + abraxas-opencode-setup repo; cleanupOnError helper pattern useful for sprite destruction on failure

## Task - domain-2

- Created `lib/core/manifest/create-manifest-action.ts` server action
- Uses `getProject()` for ownership verification (reuses existing pattern)
- Checks for active manifest via `inArray(status, ['pending', 'active', 'running'])`
- Creates manifest with status='pending', spawns sprite, updates to status='active'
- On spawn failure: marks manifest as error with errorMessage
- Returns manifest + credentials on success
- Files changed: lib/core/manifest/create-manifest-action.ts (new)
- **Learnings:** Don't need to `yield* Sprites` if just calling an Effect that uses Sprites internally; use drizzle-orm operators directly (eq, and, inArray) with Effect-wrapped db

## Task - domain-3

- Created `lib/core/manifest/get-manifests.ts`
- Accepts `projectId` parameter
- Uses `getProject()` to verify ownership (reuses existing pattern)
- Queries manifests table, ordered by `createdAt` desc
- Returns `Effect` with `Manifest[]`
- Files changed: lib/core/manifest/get-manifests.ts (new)
- **Learnings:** RSC data loading functions follow same pattern as get-projects.ts - gen function, yield db/session, simple select with ordering
